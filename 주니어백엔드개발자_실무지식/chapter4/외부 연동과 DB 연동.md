# 외부 연동과 DB 연동

- 외부 연동과 트랜잭션 처리
  - 외부 연동에 실패했을 때 트랜잭션 롤백
    - 트랜잭션 범위 안에서 외부 연동 실패시 롤백 가능
    - 읽기 타임아웃이 발생해 트랜잭션을 롤백할 때, 외부 서비스에서 성공적으로 처리했을 가능성을 염두해야함
      - 일정 주기로 두 시스템의 데이터가 일치하는지 확인하고 보정하는 방법: 불일치 건이 발견되면 수동/자동으로 보정
      - 성공 확인 API를 호출하는 방법: 읽기 타임아웃이 발생한 경우, 일정 시간 후에 이전 호출이 실제로 성공했는지 확인하는 API 호출
        - 성공 응답시, 트랜잭션 지속
        - 실패 응답시 트랜잭션 롤백
      - 취소 API를 호출하는 방법: 읽기 타임아웃이 발생한 뒤 일정 시간 후에 취소 API를 호출
        - 연동 서비스는 취소할 대상이 있다면 취소 처리 수행하고 성공 응답, 취소할 게 없다면 아무 동작 없이 성공 응답만 반환
      - But, 성공 및 취소 API를 호출하는 과정에도 읽기 타임아웃이 발생할 수 있기 떄문에, 두 시스템 간 데이터 일관성이 중요하다면 정기적으로 데이터를 확인하는 프로세스를 갖추는 것이 좋음
  - 외부 연동은 성공했지만 DB 연동에 실패해 트랜잭션 롤백
    - 취소 API를 호출해서 외부 연동을 이전 상태로 되돌려야 함
    - 이 경우도 마찬가지로 시스템 간 데이터 일관성이 중요하다면 정기적으로 데이터를 확인하는 프로세스를 갖추는 것이 좋음

- 외부 연동이 느려질 때 DB 커넥션 풀 문제
  - Ex) db 쿼리 수행(0.1초) + 외부 API 수행(4.8초) + db 쿼리 수행(0.1초)
    - db 쿼리를 실행하지 않아도 커넥션이 점유된 상태가 지속됨
  - db 연동과 무관하게 외부 연동을 실행할 수 있다면 db 커넥션을 사용하기 전이나 후에 외부 연동을 시도하는 방안 고려
    - 그러나, 외부 연동이 트랜잭션 범위 밖에서 실행되므로 트랜잭션 커밋후 외부 연동이 실패하면 롤백이 불가능해짐 -> 실패한 외부 연동에 대한 후처리 필요
      - 후처리 방법: 트랜잭션으로 반영된 데이터를 되돌리는 보상 트랜잭션, 기능 특성에 따라 데이터를 후보정
        - 보상 트랜잭션: 이전 단계에서 커밋된 작업을 반대로 되돌리는 별도의 트랜잭션(Saga 패턴)
          - Saga pattern: Saga는 긴 트랜잭션을 여러 개의 로컬 트랜잭션으로 나누고 실패시 보상 트랜잭션을 호출
